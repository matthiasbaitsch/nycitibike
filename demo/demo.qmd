---
title: Citybike data files
execute: 
  echo: true
---

```{r}
#| include: false
library(gt)
library(tidyverse)
devtools::load_all()
```

## Archives

Archives contain multiple CSV files with confusing content in a folder structure.

```{r}
archive_ls(2013) |> gt_preview()
```

Other archives contain archives, `path2` refers to the path inside the nested archive.

```{r}
archive_ls(2022) |> gt_preview()
```

Content of archives is redundant.

```{r}
line_2 <- function(archive, path) {
  archive_read_2(archive, path) |> read_lines(n_max = 2) |> pluck(2)
}

line_2(
  "2013-citibike-tripdata.zip",
  "2013-citibike-tripdata/201309-citibike-tripdata.csv"
)
line_2(
  "2013-citibike-tripdata.zip",
  "2013-citibike-tripdata/9_September/201309-citibike-tripdata_1.csv"
)
```

## CSV files

Headers in CSV files vary. In the table, year refers to the first and the last year a header shows up.

```{r}
csv_list_headers(with_years = TRUE) |> gt()
```

Date formats vary as well.

```{r}
archive_years() |>
  map(archive_ls) |>
  list_rbind() |>
  mutate(
    date = csv_extract_date_field(archive, path, path2),
    date_format = csv_identify_date_format(date)
  ) |>
  group_by(date_format) |>
  select(-path2, -depth, -year) |>
  slice_head() |>
  gt()
```

## Trips

Trips in a dataframe, individually by CSV file or collectively by year

```{r}
trips_read_one_file(
  "2013-citibike-tripdata.zip",
  "2013-citibike-tripdata/201310-citibike-tripdata.csv"
) |>
  gt_preview()

trips_read_one_file(
  "2023-citibike-tripdata.zip",
  "2023-citibike-tripdata/202302-citibike-tripdata.zip",
  "202302-citibike-tripdata_2.csv"
) |>
  gt_preview()

trips_read(2013, .progress = FALSE) |> gt_preview()
```

Station IDs are a bit of a mess in raw trips and tried to be fixed. We deal with the other obvious issues lateron.
  
  ```{r}
trips_raw_read(2023) |>
  select(starts_with("start_")) |>
  filter(str_detect(start_station_id, "5436.09|5785.1")) |>
  distinct() |>
  arrange(start_station_id) |>
  gt() |>
  fmt_number(decimals = 8)
```

## Stations

Extract stations from trips

```{r}
d_stations_raw <- trips_read(2023) |>
  stations_raw_extract()
d_stations_raw |> gt_preview()
```

Total number of IDs

```{r}
n_stations <- d_stations_raw |>
  pull(station_id) |>
  unique() |>
  length()
n_stations
```

Lots of missing data

```{r}
d_stations_raw |>
  filter(if_any(everything(), ~ is.na(.x))) |>
  gt_preview()
```

Differences can be subtle

```{r}
d_stations_raw |>
  filter(str_detect(station_id, "3704.08")) |>
  gt() |>
  fmt_number(decimals = 14)
```

Or less subtle

```{r}
d_stations_raw |>
  filter(str_detect(station_id, "3240.15")) |>
  gt()
```

