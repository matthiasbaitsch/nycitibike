---
title: Citybike data files
execute: 
  echo: true
---

```{r}
#| include: false
library(gt)
library(tidyverse)
devtools::load_all()
```

## Archives

Archives contain multiple CSV files with confusing content in a folder structure.

```{r}
archive_ls(2013) |> gt()
```

Other archives contain archives, `path2` refers to the path inside the nested archive.

```{r}
archive_ls(2022) |> gt()
```

## CSV files

Content of CSV files is redundant.

Line 2 of `2013-citibike-tripdata.zip: 2013-citibike-tripdata/201309-citibike-tripdata.csv`

```{r}
archive_read_2(
  "2013-citibike-tripdata.zip",
  "2013-citibike-tripdata/201309-citibike-tripdata.csv"
) |>
  read_lines(n_max = 2) |>
  pluck(2)
```

Line 2 of `2013-citibike-tripdata.zip: 2013-citibike-tripdata/9_September/201309-citibike-tripdata_1.csv`

```{r}
archive_read_2(
  "2013-citibike-tripdata.zip",
  "2013-citibike-tripdata/9_September/201309-citibike-tripdata_1.csv"
) |>
  read_lines(n_max = 2) |>
  pluck(2)
```

Headers in CSV files vary. In the table, year refers to the first and the last year a header shows up.

```{r}
trips_list_csv_headers(with_years = TRUE) |>
  gt()
```

Date formats vary as well.

```{r}
trips_list_years() |>
  map(archive_ls) |>
  list_rbind() |>
  mutate(
    date = csv_extract_date_field(archive, path, path2),
    date_format = csv_identify_date_format(date)
  ) |>
  group_by(date_format) |>
  select(-path2, -depth, -year) |>
  slice_head() |>
  gt()
```

### Trips

Now we can read trips into a dataframe.

```{r}
d1 <- trips_read_one_file(
  "2013-citibike-tripdata.zip",
  "2013-citibike-tripdata/201310-citibike-tripdata.csv"
)
d1 |> gt_preview()
```

```{r}
d2 <- trips_read_one_file(
  "2023-citibike-tripdata.zip",
  "2023-citibike-tripdata/202302-citibike-tripdata.zip",
  "202302-citibike-tripdata_2.csv"
)
d2 |> gt_preview()
```
